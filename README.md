

# ç¼˜èµ·

æœ€è¿‘é¡¹ç›®éœ€è¦å†™ä¸€ä¸ªç®€å•çš„ç½‘é¡µç‰ˆèŠå¤©å®¤ï¼Œæ²¡ä»€ä¹ˆå¥½è€ƒè™‘çš„ï¼Œå› ä¸ºé¡¹ç›®ä½¿ç”¨çš„æ˜¯`Java` æŠ€æœ¯æ ˆï¼Œæ‰€ä»¥ç›´æ¥é€‰ç”¨ `netty + websocket` å®ç°ã€‚å¹¶åšä¸ªç®€å•è®°å½•ï¼Œæ–¹ä¾¿æœ€å°æ¨¡å—å¤ç”¨ï½



æœ¬ç³»ç»Ÿä¸»è¦é‡‡ç”¨çŸ­è¿æ¥ + é•¿è¿æ¥ã€‚

> ç”¨æˆ·çš„æ³¨å†Œç™»å½•ã€è´¦æˆ·ç®¡ç†ã€å¥½å‹å…³ç³»é“¾ç­‰åŠŸèƒ½ä½¿ç”¨httpåè®®ï¼Œå› æ­¤å°†è¿™ä¸ªæ¨¡å—åšæˆä¸€ä¸ªrestfulæœåŠ¡ï¼Œå¯¹å¤–æš´éœ²httpæ¥å£ä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚
>
> å®æ—¶æ¶ˆæ¯ä½¿ç”¨ `websocket` 



---



[TOC]





## åŸºç¡€æ¶æ„

![è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯_8.png](./README/143817pevc88vzouj1uujd.png)

# ğŸ¯ç›®æ ‡

ä¸»è¦å°ç›®æ ‡ä»¥åŠå®ç°ã€‚

- [x] ç”¨æˆ·ä¼šè¯ç®¡ç†

- [ ] æ¶ˆæ¯çš„å¯é æ€§

  - [ ] ä¸ä¸¢å¤±
  - [ ] ä¸é‡å¤
  - [ ] ä¸ä¹±åº

  

## ç”¨æˆ·ä¼šè¯ç®¡ç†

```uml
@startuml
participant frontend as f#lightblue
participant WebSocketServerProtocolHandler as w #lightyellow
participant authHandler as a #lightgreen
participant websocketHandler as o #409EFF
participant SessionManager as s #67C23A
autonumber

f -> w : æ¡æ‰‹å‡çº§websocket
a -> a: å¯åŠ¨è¿æ¥å…³é—­å®šæ—¶å™¨
a -> a : å¯åŠ¨è®¤è¯å‚¬ä¿ƒå®šæ—¶å™¨
a -> f: å‚¬ä¿ƒå‘é€èº«ä»½è®¤è¯åŒ…ï¼Œè¶…æ—¶è‡ªåŠ¨å…³é—­è¿æ¥
f -> a: èº«ä»½è®¤è¯
a -> a: èº«ä»½è®¤è¯å®Œæ¯•ï¼Œæ¸…é™¤channelçš„è®¤è¯å¤„ç†å™¨ï¼Œæ¸…é™¤å®šæ—¶å™¨
a -> s : ä¼šè¯ channel å­˜å‚¨
f -> o : æ¶ˆæ¯
o -> f : æ¶ˆæ¯
f -> s : å‰ç«¯ç¦»çº¿ï¼Œä¼šè¯æ¸…é™¤

@enduml
```

![image-20231005164734842](./README//image-20231005164734842.png)



## ç¦»çº¿æ¶ˆæ¯

å¦‚æœç”¨æˆ·å½“å‰ä¸åœ¨çº¿ï¼Œå°±å¿…é¡»æŠŠæ¶ˆæ¯æŒä¹…åŒ–ä¸‹æ¥ï¼Œç­‰å¾…ç”¨æˆ·ä¸‹æ¬¡ä¸Šçº¿å†æ¨é€ï¼Œè¿™é‡Œä½¿ç”¨æ•°æ®åº“å­˜å‚¨ç¦»çº¿æ¶ˆæ¯ã€‚

**ä¸ºäº†æ–¹ä¾¿åœ°æ°´å¹³æ‰©å±•ï¼Œæˆ‘ä»¬åç»­å¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè§£è€¦ï¼š**

- 1ï¼‰transferæ¥æ”¶åˆ°æ¶ˆæ¯åå¦‚æœå‘ç°ç”¨æˆ·ä¸åœ¨çº¿ï¼Œå°±å‘é€ç»™æ¶ˆæ¯é˜Ÿåˆ—å…¥åº“ï¼›
- 2ï¼‰ç”¨æˆ·ç™»å½•æ—¶ï¼ŒæœåŠ¡å™¨ä»åº“é‡Œæ‹‰å–ç¦»çº¿æ¶ˆæ¯è¿›è¡Œæ¨é€ã€‚



## æ¶ˆæ¯å¯é æ€§

> ç½‘ä¸Šæœ‰å¤§ç¥æ•´ç†å¥½äº†ï¼Œä½œä¸ºä¸€ååˆæ ¼çš„ğŸ§‘â€ğŸ’»å’±å°±ç›´æ¥`cv`äº†ï½

### ä¸ä¸¢å¤±

æˆ‘ä»¬å…ˆä»ä¸ä¸¢æ¶ˆæ¯å¼€å§‹è®²èµ·ã€‚

**é¦–å…ˆå¤ä¹ ä¸€ä¸‹ä¸Šé¢ç« èŠ‚ä¸­è®¾è®¡çš„æœåŠ¡ç«¯æ¶æ„ï¼š**

![è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯_1.png](./README/150729wyz747ybkkppph87.png)



**æˆ‘ä»¬å…ˆä»ä¸€ä¸ªç®€å•ä¾‹å­å¼€å§‹æ€è€ƒï¼š**å½“Aliceç»™Bobå‘é€ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå¯èƒ½è¦ç»è¿‡è¿™æ ·ä¸€æ¡é“¾è·¯ï¼š

![è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯_2.png](./README/150805z353hv35w38312zs.png)

```shel
1ï¼‰client-->connecter
2ï¼‰connector-->transfer
3ï¼‰transfer-->connector
4ï¼‰connector-->client
```

åœ¨è¿™æ•´ä¸ªé“¾è·¯ä¸­çš„æ¯ä¸ªç¯èŠ‚éƒ½æœ‰å¯èƒ½å‡ºé—®é¢˜ï¼Œè™½ç„¶tcpåè®®æ˜¯å¯é çš„ï¼Œä½†æ˜¯å®ƒåªèƒ½ä¿è¯é“¾è·¯å±‚çš„å¯é ï¼Œæ— æ³•ä¿è¯åº”ç”¨å±‚çš„å¯é ã€‚

ä¾‹å¦‚åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œconnectoræ”¶åˆ°äº†ä»clientå‘å‡ºçš„æ¶ˆæ¯ï¼Œä½†æ˜¯è½¬å‘ç»™transferå¤±è´¥ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯Bobå°±æ— æ³•æ”¶åˆ°ï¼Œè€ŒAliceä¹Ÿä¸ä¼šæ„è¯†åˆ°æ¶ˆæ¯å‘é€å¤±è´¥äº†ã€‚

**å¦‚æœBobçŠ¶æ€æ˜¯ç¦»çº¿ï¼Œé‚£ä¹ˆæ¶ˆæ¯é“¾è·¯å°±æ˜¯ï¼š**

```shell
1ï¼‰client-->connector
2ï¼‰connector-->transfer
3ï¼‰transfer-->mq
```



å¦‚æœåœ¨ç¬¬ä¸‰æ­¥ä¸­ï¼Œtransferæ”¶åˆ°äº†æ¥è‡ªconnectorçš„æ¶ˆæ¯ï¼Œä½†æ˜¯ç¦»çº¿æ¶ˆæ¯å…¥åº“å¤±è´¥ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¶ˆæ¯ä¹Ÿæ˜¯ä¼ é€’å¤±è´¥äº†ã€‚

ä¸ºäº†ä¿è¯åº”ç”¨å±‚çš„å¯é ï¼Œæˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªackæœºåˆ¶ï¼Œä½¿å‘é€æ–¹èƒ½å¤Ÿç¡®è®¤å¯¹æ–¹æ”¶åˆ°äº†è¿™æ¡æ¶ˆæ¯ã€‚

å…·ä½“çš„å®ç°ï¼Œæˆ‘ä»¬æ¨¡ä»¿tcpåè®®åšä¸€ä¸ªåº”ç”¨å±‚çš„ackæœºåˆ¶ã€‚

tcpçš„æŠ¥æ–‡æ˜¯ä»¥å­—èŠ‚ï¼ˆbyteï¼‰ä¸ºå•ä½çš„ï¼Œè€Œæˆ‘ä»¬ä»¥messageå•ä½ã€‚



![è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯_3.png](./README/150915v8xnmxg50000q0zm.png)



å‘é€æ–¹æ¯æ¬¡å‘é€ä¸€ä¸ªæ¶ˆæ¯ï¼Œå°±è¦ç­‰å¾…å¯¹æ–¹çš„ackå›åº”ï¼Œåœ¨ackç¡®è®¤æ¶ˆæ¯ä¸­åº”è¯¥å¸¦æœ‰æ”¶åˆ°çš„idä»¥ä¾¿å‘é€æ–¹è¯†åˆ«ã€‚

å…¶æ¬¡ï¼Œå‘é€æ–¹éœ€è¦ç»´æŠ¤ä¸€ä¸ªç­‰å¾…ackçš„é˜Ÿåˆ—ã€‚ æ¯æ¬¡å‘é€ä¸€ä¸ªæ¶ˆæ¯ä¹‹åï¼Œå°±å°†æ¶ˆæ¯å’Œä¸€ä¸ªè®¡æ—¶å™¨å…¥é˜Ÿã€‚

å¦å¤–å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´è½®è¯¢é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰è¶…æ—¶æœªæ”¶åˆ°ackçš„ï¼Œå°±å–å‡ºæ¶ˆæ¯é‡å‘ã€‚

**è¶…æ—¶æœªæ”¶åˆ°ackçš„æ¶ˆæ¯æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š**

- 1ï¼‰å’Œtcpä¸€æ ·ä¸æ–­å‘é€ç›´åˆ°æ”¶åˆ°ackä¸ºæ­¢ã€‚
- 2ï¼‰è®¾å®šä¸€ä¸ªæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ¬¡æ•°è¿˜æ²¡æ”¶åˆ°ackï¼Œå°±ä½¿ç”¨å¤±è´¥æœºåˆ¶å¤„ç†ï¼ŒèŠ‚çº¦èµ„æºã€‚ä¾‹å¦‚å¦‚æœæ˜¯connectoré•¿æ—¶é—´æœªæ”¶åˆ°clientçš„ackï¼Œé‚£ä¹ˆå¯ä»¥ä¸»åŠ¨æ–­å¼€å’Œå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå‰©ä¸‹æœªå‘é€çš„æ¶ˆæ¯å°±ä½œä¸ºç¦»çº¿æ¶ˆæ¯å…¥åº“ï¼Œå®¢æˆ·ç«¯æ–­è¿åå°è¯•é‡è¿æœåŠ¡å™¨å³å¯ã€‚

### ä¸é‡å¤ã€ä¸ä¹±åº

æœ‰çš„æ—¶å€™å› ä¸ºç½‘ç»œåŸå› å¯èƒ½å¯¼è‡´ackæ”¶åˆ°è¾ƒæ…¢ï¼Œå‘é€æ–¹å°±ä¼šé‡å¤å‘é€ï¼Œé‚£ä¹ˆæ¥æ”¶æ–¹å¿…é¡»æœ‰ä¸€ä¸ªå»é‡æœºåˆ¶ã€‚

å»é‡çš„æ–¹å¼æ˜¯ç»™æ¯ä¸ªæ¶ˆæ¯å¢åŠ ä¸€ä¸ªå”¯ä¸€idã€‚è¿™ä¸ªå”¯ä¸€idå¹¶ä¸ä¸€å®šæ˜¯å…¨å±€çš„ï¼Œåªéœ€è¦åœ¨ä¸€ä¸ªä¼šè¯ä¸­å”¯ä¸€å³å¯ã€‚

ä¾‹å¦‚æŸä¸¤ä¸ªäººçš„ä¼šè¯ï¼Œæˆ–è€…æŸä¸€ä¸ªç¾¤ã€‚å¦‚æœç½‘ç»œæ–­è¿äº†ï¼Œé‡æ–°è¿æ¥åï¼Œå°±æ˜¯æ–°çš„ä¼šè¯äº†ï¼Œidä¼šé‡æ–°ä»0å¼€å§‹ã€‚

æ¥æ”¶æ–¹éœ€è¦åœ¨å½“å‰ä¼šè¯ä¸­ç»´æŠ¤æ”¶åˆ°çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„idï¼Œå«åšlastIdã€‚

æ¯æ¬¡æ”¶åˆ°ä¸€ä¸ªæ–°æ¶ˆæ¯ï¼Œ å°±å°†idä¸lastIdä½œæ¯”è¾ƒçœ‹æ˜¯å¦è¿ç»­ï¼Œå¦‚æœä¸è¿ç»­ï¼Œå°±æ”¾å…¥ä¸€ä¸ªæš‚å­˜é˜Ÿåˆ— queueä¸­ç¨åå¤„ç†ã€‚

**ä¾‹å¦‚ï¼š**

- 1ï¼‰å½“å‰ä¼šè¯çš„lastId=1ï¼Œæ¥ç€æœåŠ¡å™¨æ”¶åˆ°äº†æ¶ˆæ¯msg(id=2)ï¼Œå¯ä»¥åˆ¤æ–­æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œå°±å¤„ç†æ¶ˆæ¯ï¼Œå°†lastIdä¿®æ”¹ä¸º2ï¼›
- 2ï¼‰ä½†æ˜¯å¦‚æœæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯msg(id=3)ï¼Œå°±è¯´æ˜æ¶ˆæ¯ä¹±åºåˆ°è¾¾äº†ï¼Œé‚£ä¹ˆå°±å°†è¿™ä¸ªæ¶ˆæ¯å…¥é˜Ÿï¼Œç­‰å¾…lastIdå˜ä¸º2åï¼Œï¼ˆå³æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯msg(id=2)å¹¶å¤„ç†å®Œäº†ï¼‰ï¼Œå†å–å‡ºè¿™ä¸ªæ¶ˆæ¯å¤„ç†ã€‚

å› æ­¤ï¼Œåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦é‡å¤åªéœ€è¦åˆ¤æ–­msgId>lastId && !queue.contains(msgId)å³å¯ã€‚å¦‚æœæ”¶åˆ°é‡å¤çš„æ¶ˆæ¯ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯ackæœªé€è¾¾ï¼Œå°±å†å‘é€ä¸€æ¬¡ackã€‚

**æ¥æ”¶æ–¹æ”¶åˆ°æ¶ˆæ¯åå®Œæ•´çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š**

![è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯_4.png](./README/151227u706ao29s90sr7an.png)

## å­˜å‚¨è®¾è®¡

* æ¶ˆæ¯åè®®

```java
@AllArgsConstructor
@NoArgsConstructor
@Data
@Builder
public class ChatMsg<T> implements Serializable {

    // æ¶ˆæ¯ç±»å‹
    private CommandTypeEnum type;

    // ç›®æ ‡æ¥å—å¯¹è±¡
    private Integer target;

    private T content;
}

```



* æ¶ˆæ¯ç±»å‹

```java
public enum CommandTypeEnum {
    /**
     * ç³»ç»Ÿä¿¡æ¯
     */
    @SerializedName("10000")
    SYSTEM(10000),


    /**
     * å»ºç«‹è¿æ¥
     */
    @SerializedName("10001")
    CONNECTION(10001),

    /**
     * è®¤è¯
     */
    @SerializedName("10002")
    AUTH(10002),


    /**
     * èŠå¤©
     */
    @SerializedName("10003")
    PRIVATE_CHAT(10003),

    @SerializedName("-1")
    ERROR(-1)

    ;


    private final Integer code;

}
```







# å·¨äººçš„è‚©è†€

1. [**è·Ÿç€æºç å­¦IM(ä¸‰)ï¼šåŸºäºNettyï¼Œä»é›¶å¼€å‘ä¸€ä¸ªIMæœåŠ¡ç«¯**](http://www.52im.net/thread-2768-1-1.html)
2. 





# å°é—®é¢˜

## 1. `SimpleChannelInboundHandler`ä¸­`channelread`å’Œ`channelread0`çš„åŒºåˆ«

![image-20231001233008590](./README//image-20231001233008590.png)



```java
package io.netty.channel;

public abstract class SimpleChannelInboundHandler<I> extends ChannelInboundHandlerAdapter {
...
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        boolean release = true;
        try {
            if (this.acceptInboundMessage(msg)) {
                this.channelRead0(ctx, msg);
            } else {
                release = false;
                ctx.fireChannelRead(msg);
            }
        } finally {
            if (this.autoRelease && release) {
                ReferenceCountUtil.release(msg);
            }
        }

    }
    protected abstract void channelRead0(ChannelHandlerContext var1, I var2) throws Exception;
}

```

> å¯ä»¥çœ‹åˆ°ï¼Œ`channelRead` æ˜¯`public `ç±»å‹ï¼Œå¯ä»¥è¢«å¤–éƒ¨è®¿é—®ï¼›
>
> è€Œ`channelRead0`æ˜¯`protected`ç±»å‹ï¼Œåªèƒ½è¢«å½“å‰ç±»åŠå…¶å­ç±»è®¿é—®ã€‚
>
> `channelRead`ä¸­è°ƒç”¨äº†`channelRead0`ï¼Œé‚£ä¹ˆ`channelRead`åˆé¢å¤–å¤šåšäº†ä»€ä¹ˆå‘¢ï¼Ÿ
>
> å¾ˆæ˜æ˜¾åšäº†ä¸€ä¸ªæ¶ˆæ¯ç±»å‹æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦ä¼šä¼ é€’åˆ°ä¸‹ä¸€ä¸ªhandler



---



## 2. ä¸ºä»€ä¹ˆé€‰æ‹©åœ¨`http`è¯·æ±‚æˆåŠŸå‡çº§`websocket`ä¹‹åå†åšæƒé™è®¤è¯

å› ä¸ºåœ¨è®¤è¯è¿‡ç¨‹ä¸­éœ€è¦ç»™å‰ç«¯æ¨é€ç›¸å…³æ¶ˆæ¯ï¼Œè€Œåœ¨`http` æœªå‡çº§åˆ° `webscket`ä¹‹å‰ï¼ŒæœåŠ¡ç«¯æ— æ³•ä¸»åŠ¨æ¨é€æ¶ˆæ¯ã€‚



## 3. æ€ä¹ˆç¡®ä¿è®¤è¯åªè¿›è¡Œä¸€æ¬¡

åœ¨ `netty` çš„`pipeline` æ”¯æŒçƒ­æ‹”æ’ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åˆ é™¤æŸä¸ª`handler`, æ³¨æ„ç»†èŠ‚ï¼Œä¸è¦ä½¿ç”¨ `bean` æ³¨å…¥ã€‚

![image-20231005162641190](./README//image-20231005162641190.png)



# é¡¹ç›®ç»“æœ

## è¿æ¥åå‚¬ä¿ƒè®¤è¯

![image-20231005160434007](./README//image-20231005160434007.png)

## è¶…æ—¶æœªè®¤è¯è¿æ¥è‡ªåŠ¨å…³é—­

![image-20231005161702096](./README//image-20231005161702096.png)

![image-20231005161748309](./README//image-20231005161748309.png)

## è®¤è¯æˆåŠŸ

![image-20231005160722515](./README//image-20231005160722515.png)

## ä¼šè¯æ·»åŠ 

![image-20231005160822628](./README//image-20231005160822628.png)

## ç§èŠ

![image-20231005161039871](./README//image-20231005161039871.png)

## ç¦»çº¿æ¶ˆæ¯

![image-20231005161115373](./README//image-20231005161115373.png)

![image-20231005161210629](./README//image-20231005161210629.png)
